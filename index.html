<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Enscribe: Image → Audio (with Linear Spectrogram)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --ink:#e6e8ee; --muted:#98a2b3; --accent:#6ee7ff; --accent2:#a78bfa; --danger:#ff7b7b;
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; background:var(--bg); color:var(--ink); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap{ max-width:1100px; margin:24px auto; padding:0 16px; }
    header{ display:flex; gap:16px; align-items:center; margin-bottom:16px; }
    header h1{ font-size:22px; margin:0; }
    header .hint{ color:var(--muted); font-size:13px; }
    .grid{ display:grid; grid-template-columns:1.1fr .9fr; gap:18px; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .card{ background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.08);
           border-radius:var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card h2{ font-size:16px; padding:14px 16px; margin:0; border-bottom:1px solid rgba(255,255,255,.06); color:#eaf7ff; }
    .card .body{ padding:14px 16px; }

    .drop{ border:2px dashed rgba(255,255,255,.18); border-radius:12px; padding:18px; text-align:center; cursor:pointer;
           transition:border-color .2s, background .2s; }
    .drop.drag{ border-color:var(--accent); background:rgba(110,231,255,.06); }
    .drop input{ display:none; }
    .actions{ display:flex; gap:10px; margin-top:12px; align-items:center; }
    button{
      appearance:none; border:0; background:linear-gradient(120deg, var(--accent), var(--accent2));
      color:#091016; font-weight:600; padding:10px 14px; border-radius:12px; cursor:pointer;
      box-shadow: 0 6px 18px rgba(110,231,255,.25); transition: transform .06s ease;
    }
    button:hover{ transform: translateY(-1px); }
    .muted{ color:var(--muted); }
    .row{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .imgprev{ width:100%; border-radius:12px; background:#0b0d12; border:1px solid rgba(255,255,255,.08); display:grid; place-items:center; aspect-ratio:16/10; overflow:hidden; }
    .imgprev img{ max-width:100%; height:auto; display:block; }
    .audio-wrap{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    audio{ width:100%; max-width:100%; filter: drop-shadow(0 5px 16px rgba(0,0,0,.35)); }
    .status{ margin-top:10px; font-size:14px; }
    .status.ok{ color:#b1f4cf; }
    .status.err{ color:var(--danger); }
    .small{ font-size:12px; color:var(--muted); }

    canvas{ width:100%; height:420px; display:block; border-radius:12px; background:#05070c; border:1px solid rgba(255,255,255,.08); }
    .controlbar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:10px 0 0; }
    .controlbar label{ font-size:12px; color:var(--muted); display:flex; align-items:center; gap:6px; }
    select, input[type="range"]{
      background:#0e1218; color:var(--ink); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:6px 8px;
    }
    .legend{ display:flex; gap:10px; align-items:center; margin-top:6px; }
    .swatch{ width:18px; height:12px; background: linear-gradient(90deg, #000, #fff); border-radius:4px; border:1px solid rgba(255,255,255,.12); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Enscribe</h1>
      <div class="hint">Upload an image → server returns a WAV → we play it and draw a linear-frequency spectrogram.</div>
    </header>

    <div class="grid">
      <!-- LEFT: Controls + Preview -->
      <section class="card">
        <h2>1) Upload & Generate Audio</h2>
        <div class="body">
          <form id="enscribe-form" action="enscribe.php" method="post" enctype="multipart/form-data">
            <label class="drop" id="drop">
              <input id="file" type="file" name="image" accept="image/png, image/jpeg, image/gif" />
              <div>
                <div style="font-weight:600; margin-bottom:6px;">Drop an image here, or click to choose</div>
                <div class="muted">JPG / PNG / GIF • ≤ 10 MB</div>
              </div>
            </label>

            <div class="actions">
              <button id="btn-generate" type="submit">Generate Audio</button>
              <span class="muted small">Server rotates 90° clockwise before enscribe.</span>
            </div>
          </form>

          <div class="row" style="margin-top:14px;">
            <div class="imgprev" id="imgprev"><span class="muted">Image preview</span></div>
          </div>

          <div class="status" id="status"></div>
        </div>
      </section>

      <!-- RIGHT: Audio + Spectrogram -->
      <section class="card">
        <h2>2) Listen & View Spectrogram (Linear Frequency)</h2>
        <div class="body">
          <div class="audio-wrap">
            <audio id="player" controls preload="none"></audio>
          </div>

          <div class="controlbar">
            <label>FFT size
              <select id="fft">
                <option value="1024">1024</option>
                <option value="2048" selected>2048</option>
                <option value="4096">4096</option>
                <option value="8192">8192</option>
              </select>
            </label>
            <label>Smoothing
              <input id="smooth" type="range" min="0" max="0.95" step="0.05" value="0" />
            </label>
            <label>Scroll speed (px/frame)
              <input id="speed" type="range" min="1" max="4" step="1" value="1" />
            </label>
            <div class="legend"><div class="swatch"></div><span class="small">Grayscale magnitude</span></div>
          </div>

          <div style="margin-top:10px;">
            <canvas id="spec" width="1024" height="512" aria-label="Spectrogram"></canvas>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    (() => {
      const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
      const $ = (s, p=document) => p.querySelector(s);

      const form = $('#enscribe-form');
      const fileInput = $('#file');
      const drop = $('#drop');
      const imgPrev = $('#imgprev');
      const statusEl = $('#status');
      const audioEl = $('#player');
      const canvas = $('#spec');
      const fftSel = $('#fft');
      const smoothRange = $('#smooth');
      const speedRange = $('#speed');

      // --- Audio graph (audible + analysable)
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const analyser = audioCtx.createAnalyser();
      analyser.fftSize = parseInt(fftSel.value, 10);
      analyser.smoothingTimeConstant = parseFloat(smoothRange.value);

      const gain = audioCtx.createGain();
      gain.gain.value = 1;

      // Create MediaElement source ONCE and feed analyser + destination
      const mediaSrc = audioCtx.createMediaElementSource(audioEl);
      mediaSrc.connect(analyser);
      analyser.connect(gain);
      gain.connect(audioCtx.destination);

      // --- Spectrogram (linear frequency)
      const ctx = canvas.getContext('2d');
      function resizeCanvas() {
        const cssW = canvas.clientWidth || 1024;
        const cssH = canvas.clientHeight || 420;
        canvas.width  = Math.floor(cssW * dpr);
        canvas.height = Math.floor(cssH * dpr);
        ctx.setTransform(1,0,0,1,0,0); // reset transform
        ctx.imageSmoothingEnabled = false;
      }
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      let pxSpeed = parseInt(speedRange.value, 10);
      let bins = analyser.frequencyBinCount;
      let freq = new Uint8Array(bins);

      function drawSpectrogram() {
        // read FFT magnitudes
        if (analyser.fftSize !== parseInt(fftSel.value, 10)) {
          analyser.fftSize = parseInt(fftSel.value, 10);
          bins = analyser.frequencyBinCount;
          freq = new Uint8Array(bins);
        }
        analyser.smoothingTimeConstant = parseFloat(smoothRange.value);
        pxSpeed = parseInt(speedRange.value, 10);

        analyser.getByteFrequencyData(freq);

        const w = canvas.width;
        const h = canvas.height;

        // Shift image left by pxSpeed
        if (w > pxSpeed) {
          const img = ctx.getImageData(pxSpeed, 0, w - pxSpeed, h);
          ctx.putImageData(img, 0, 0);
        }
        // Fill rightmost pxSpeed columns
        for (let x = 0; x < pxSpeed; x++) {
          for (let y = 0; y < h; y++) {
            const bin = Math.min(bins - 1, Math.floor((y / h) * bins)); // LINEAR frequency mapping
            const v = freq[bin]; // 0..255
            ctx.fillStyle = `rgb(${v},${v},${v})`;
            ctx.fillRect(w - 1 - x, h - 1 - y, 1, 1);
          }
        }
        requestAnimationFrame(drawSpectrogram);
      }
      requestAnimationFrame(drawSpectrogram);

      // --- Image preview
      function setPreview(file) {
        if (!file) { imgPrev.innerHTML = '<span class="muted">Image preview</span>'; return; }
        const url = URL.createObjectURL(file);
        imgPrev.innerHTML = '';
        const img = new Image();
        img.onload = () => URL.revokeObjectURL(url);
        img.src = url;
        imgPrev.appendChild(img);
      }

      // --- Drag & drop
      ['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, e => {
        e.preventDefault(); e.stopPropagation(); drop.classList.add('drag');
      }));
      ['dragleave','drop'].forEach(ev => drop.addEventListener(ev, e => {
        e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag');
      }));
      drop.addEventListener('drop', (e) => {
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if (f) { fileInput.files = e.dataTransfer.files; setPreview(f); }
      });
      drop.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', () => setPreview(fileInput.files[0]));

      function setStatus(msg, ok=false){
        statusEl.textContent = msg || '';
        statusEl.className = 'status ' + (ok ? 'ok' : (msg ? 'err' : ''));
      }

      // --- Form submit → PHP → play
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const f = fileInput.files[0];
        if (!f) { setStatus('Please choose an image first.'); return; }

        try {
          setStatus('Uploading & generating…');
          if (audioCtx.state !== 'running') await audioCtx.resume();

          const fd = new FormData(form);
          const res = await fetch(form.action || 'enscribe.php', { method:'POST', body: fd });
          const json = await res.json();

          if (!json.success) {
            setStatus(json.message || 'Server error'); return;
          }

          // Use returned URL (already with cache-buster); make absolute against current page
          const absUrl = new URL(json.audioUrl, location.href).toString();

          // Load into <audio> element so we get UI controls
          audioEl.src = absUrl;
          await audioEl.load();

          // Try to play (will work since this is inside a click/submit gesture)
          await audioEl.play();

          setStatus('Done. Playing.', true);
        } catch (err) {
          console.error(err);
          setStatus('Failed: ' + (err?.message || err));
        }
      });

      // Autoplay policy: resume on first user interaction anywhere
      const resumeOnce = async () => {
        try { if (audioCtx.state !== 'running') await audioCtx.resume(); }
        catch(_){} finally {
          window.removeEventListener('pointerdown', resumeOnce, {once:true});
        }
      };
      window.addEventListener('pointerdown', resumeOnce, {once:true});
    })();
  </script>
</body>
</html>
